<%- include('../partials/header') %>


<div class="page-container animate-fade-in">
    <div class="page-header">
        <h1>Mark Attendance</h1>
        <div class="header-actions">
            <a href="/attendance/view" class="btn secondary-btn">
                <!-- <i class="feather-list"></i> View Attendance Records -->
                    <i data-feather="list"></i> View Attendance Records
            </a>
            <a href="/" class="btn outline-btn">
                <!-- <i class="feather-home"></i> Home -->
                    <i data-feather="home"></i> Home
            </a>
        </div>
    </div>
    
    <% if (locals.error) { %>
        <div class="alert alert-error animate-shake">
            <!-- <i class="feather-alert-circle"></i> -->
                <i data-feather="alert-circle"></i>
            <%= error %>
        </div>
    <% } %>
    
    <div class="card attendance-card animate-slide-up">
        <div class="attendance-header">
            <div class="form-group date-group">
                <label for="attendanceDate">Date</label>
                <input type="date" id="attendanceDate" value="<%= date %>">
            </div>
            
            <div class="form-group marked-by-group">
                <label for="markedBy">Marked By</label>
                <input type="text" id="markedBy" placeholder="Enter your name">
            </div>
            
            <div class="search-container">
                <div class="search-input">
                    <i class="feather-search"></i>
                    <input type="text" id="studentSearch" placeholder="Search students...">
                </div>
            </div>
        </div>
        
        <div class="attendance-controls">
            <button class="btn outline-btn mark-all-btn" data-status="present">
                <!-- <i class="feather-check-circle"></i> Mark All Present -->
                <i data-feather="check-circle"></i> Mark All Present
            </button>
            <button class="btn outline-btn mark-all-btn" data-status="absent">
                <!-- <i class="feather-x-circle"></i> Mark All Absent -->
                <i data-feather="x-circle"></i> Mark All Absent
            </button>
            <button class="btn outline-btn clear-all-btn">
                <!-- <i class="feather-refresh-cw"></i> Clear All -->
                <i data-feather="refresh-cw"></i> Clear All
            </button>
        </div>
        
        <div class="table-container">
            <table class="data-table attendance-table">
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Course</th>
                        <th>Semester</th>
                        <th>Status</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (students && students.length > 0) { %>
                        <% students.forEach(student => { %>
                            <tr class="attendance-row animate-fade-in-row" data-id="<%= student._id %>">
                                <td><%= student.rollNumber %></td>
                                <td><%= student.name %></td>
                                <td><%= student.course %></td>
                                <td><%= student.semester %></td>
                                <td>
                                    <div class="status-buttons">
                                        <button type="button" class="status-btn present-btn" data-status="present">
                                            <!-- <i class="feather-check"></i> Present -->
                                            <i data-feather="check"></i> Present
                                        </button>
                                        <button type="button" class="status-btn absent-btn" data-status="absent">
                                            <!-- <i class="feather-x"></i> Absent -->
                                            <i data-feather="x"></i> Absent
                                        </button>
                                        <button type="button" class="status-btn late-btn" data-status="late">
                                            <!-- <i class="feather-clock"></i> Late -->
                                            <i data-feather="clock"></i> Late
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <input type="text" class="notes-input" placeholder="Add notes (optional)">
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" class="no-data">No students found</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
        
        <div class="submit-container">
            <button id="submitAttendance" class="btn primary-btn submit-btn">
                <!-- <i class="feather-check-square"></i> Submit Attendance -->
                <i data-feather="check-square"></i> Submit Attendance
            </button>
        </div>
    </div>
</div>

<!-- Success notification -->
<div class="notification success-notification" id="successNotification">
    <!-- <i class="feather-check-circle"></i> -->
    <i data-feather="check-circle"></i>
    <span>Attendance marked successfully!</span>
</div>

<!-- Error notification -->
<div class="notification error-notification" id="errorNotification">
    <!-- <i class="feather-alert-circle"></i> -->
    <i data-feather="alert-circle"></i>
    <span id="errorMessage">An error occurred.</span>
</div>

<script>
    
    // Variables to track attendance state
    const attendanceData = {};
    
    // Initialize status buttons
    function initStatusButtons() {
        const statusBtns = document.querySelectorAll('.status-btn');
        
        statusBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const row = this.closest('.attendance-row');
                const studentId = row.dataset.id;
                const status = this.dataset.status;
                
                // Remove active class from all buttons in this row
                row.querySelectorAll('.status-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Add animation
                this.classList.add('animate-pop');
                setTimeout(() => {
                    this.classList.remove('animate-pop');
                }, 300);
                
                // Update attendance data
                const notes = row.querySelector('.notes-input').value;
                attendanceData[studentId] = { studentId, status, notes };
            });
        });
    }
    
    // Search functionality
    document.getElementById('studentSearch').addEventListener('input', function() {
        const searchValue = this.value.toLowerCase();
        const tableRows = document.querySelectorAll('.attendance-table tbody tr');
        
        tableRows.forEach(row => {
            if (!row.classList.contains('no-data')) {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    });
    
    // Mark all buttons
    document.querySelectorAll('.mark-all-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const status = this.dataset.status;
            const rows = document.querySelectorAll('.attendance-row');
            
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const studentId = row.dataset.id;
                    const statusBtn = row.querySelector(`.status-btn[data-status="${status}"]`);
                    const notes = row.querySelector('.notes-input').value;
                    
                    // Clear all active buttons
                    row.querySelectorAll('.status-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Set active status
                    statusBtn.classList.add('active');
                    
                    // Update attendance data
                    attendanceData[studentId] = { studentId, status, notes };
                }
            });
            
            // Animate the mark all button
            this.classList.add('animate-pop');
            setTimeout(() => {
                this.classList.remove('animate-pop');
            }, 300);
        });
    });
    
    // Clear all button
    document.querySelector('.clear-all-btn').addEventListener('click', function() {
        const rows = document.querySelectorAll('.attendance-row');
        
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const studentId = row.dataset.id;
                
                // Clear all active buttons
                row.querySelectorAll('.status-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Clear notes
                row.querySelector('.notes-input').value = '';
                
                // Remove from attendance data
                delete attendanceData[studentId];
            }
        });
        
        // Animate the clear all button
        this.classList.add('animate-pop');
        setTimeout(() => {
            this.classList.remove('animate-pop');
        }, 300);
    });
    
    // Submit attendance
    document.getElementById('submitAttendance').addEventListener('click', function() {
        const date = document.getElementById('attendanceDate').value;
        const markedBy = document.getElementById('markedBy').value;
        
        if (!date) {
            showError('Please select a date');
            return;
        }
        
        if (!markedBy) {
            showError('Please enter your name in the "Marked By" field');
            return;
        }
        
        const attendanceValues = Object.values(attendanceData);
        
        if (attendanceValues.length === 0) {
            showError('No attendance has been marked');
            return;
        }
        
        // Disable submit button and show loading state
        this.disabled = true;
        this.innerHTML = '<i class="feather-loader spinning"></i> Submitting...';
        
        // Send data to server
        fetch('/attendance/mark', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                date,
                markedBy,
                attendanceData: attendanceValues
            })
        })
        .then(response => response.json())
        .then(data => {
            this.disabled = false;
            this.innerHTML = '<i class="feather-check-square"></i> Submit Attendance';
            
            if (data.success) {
                showSuccess('Attendance marked successfully!');
                
                // Reset form after success
                setTimeout(() => {
                    // Clear all selections but keep the date and marked by
                    document.querySelectorAll('.status-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    document.querySelectorAll('.notes-input').forEach(input => {
                        input.value = '';
                    });
                    
                    // Clear attendance data
                    Object.keys(attendanceData).forEach(key => {
                        delete attendanceData[key];
                    });
                }, 1500);
            } else {
                showError(data.error || 'Failed to mark attendance');
            }
        })
        .catch(error => {
            this.disabled = false;
            this.innerHTML = '<i class="feather-check-square"></i> Submit Attendance';
            showError('An error occurred. Please try again.');
            console.error('Error:', error);
        });
    });
    
    // Show success notification
    function showSuccess(message) {
        const notification = document.getElementById('successNotification');
        notification.querySelector('span').textContent = message;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    // Show error notification
    function showError(message) {
        const notification = document.getElementById('errorNotification');
        notification.querySelector('span').textContent = message;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initStatusButtons();
    });
</script>

<%- include('../partials/footer') %>
